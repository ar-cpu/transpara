<!DOCTYPE html>
<html>
<head>
    <title>Transpara - Quick Test</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        textarea { width: 100%; height: 150px; padding: 10px; margin: 10px 0; }
        .result { background: #f0f9ff; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .error { background: #fee2e2; color: #991b1b; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üéØ Transpara Political Bias Detector</h1>
    <p>Testing backend API - <span id="status" style="color: gray;">Checking...</span></p>

    <h2>1. Register a User</h2>
    <input type="text" id="reg-username" placeholder="Username" style="padding: 10px; margin: 5px;">
    <input type="email" id="reg-email" placeholder="Email" style="padding: 10px; margin: 5px;">
    <input type="password" id="reg-password" placeholder="Password (min 8 chars, 1 uppercase, 1 number)" style="padding: 10px; margin: 5px; width: 300px;">
    <br><button onclick="register()">Register</button>
    <div id="reg-result"></div>

    <h2>2. Login</h2>
    <input type="text" id="login-username" placeholder="Username or Email" style="padding: 10px; margin: 5px;">
    <input type="password" id="login-password" placeholder="Password" style="padding: 10px; margin: 5px;">
    <br><button onclick="login()">Login</button>
    <div id="login-result"></div>

    <h2>3. Analyze Text (Requires Login)</h2>
    <textarea id="text-input" placeholder="Enter text to analyze for political bias...">
The government's new policy represents a balanced approach to addressing climate change while maintaining economic growth.
    </textarea>
    <button onclick="analyzeText()">Analyze Bias</button>
    <div id="text-result"></div>

    <script>
        const BACKEND = 'http://localhost';
        let accessToken = '';

        // Check backend status
        fetch(`${BACKEND}/health`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('status').innerHTML = '<span style="color: green;">‚úÖ Backend Running</span>';
            })
            .catch(() => {
                document.getElementById('status').innerHTML = '<span style="color: red;">‚ùå Backend Offline</span>';
            });

        async function register() {
            const username = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            try {
                const response = await fetch(`${BACKEND}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('reg-result').innerHTML = `<div class="result">‚úÖ Registered! Now login with your credentials.</div>`;
                } else {
                    document.getElementById('reg-result').innerHTML = `<div class="result error">‚ùå ${data.error}</div>`;
                }
            } catch (err) {
                document.getElementById('reg-result').innerHTML = `<div class="result error">Connection failed: ${err.message}</div>`;
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${BACKEND}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    document.getElementById('login-result').innerHTML = `<div class="result">‚úÖ Logged in as ${data.user.username}! Token saved. You can now analyze text.</div>`;
                } else {
                    document.getElementById('login-result').innerHTML = `<div class="result error">‚ùå ${data.error}</div>`;
                }
            } catch (err) {
                document.getElementById('login-result').innerHTML = `<div class="result error">Connection failed: ${err.message}</div>`;
            }
        }

        async function analyzeText() {
            if (!accessToken) {
                document.getElementById('text-result').innerHTML = `<div class="result error">‚ùå Please login first!</div>`;
                return;
            }

            const text = document.getElementById('text-input').value;

            try {
                const response = await fetch(`${BACKEND}/api/v1/analyze/text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('text-result').innerHTML = `
                        <div class="result">
                            <h3>üìä Analysis Results:</h3>
                            <p><strong>Prediction:</strong> ${data.prediction.toUpperCase()}</p>
                            <p><strong>Confidence:</strong> ${(data.confidence * 100).toFixed(1)}%</p>
                            <p><strong>Probabilities:</strong></p>
                            <ul>
                                <li>Left: ${(data.probabilities.left * 100).toFixed(1)}%</li>
                                <li>Center: ${(data.probabilities.center * 100).toFixed(1)}%</li>
                                <li>Right: ${(data.probabilities.right * 100).toFixed(1)}%</li>
                            </ul>
                            <p><strong>Interpretation:</strong> ${data.interpretation}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('text-result').innerHTML = `<div class="result error">‚ùå ${data.error || data.message}</div>`;
                }
            } catch (err) {
                document.getElementById('text-result').innerHTML = `<div class="result error">Connection failed: ${err.message}</div>`;
            }
        }
    </script>
</body>
</html>
